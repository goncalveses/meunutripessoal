<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrativo - Dieta Bot</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100">
    
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform transition-transform duration-300 ease-in-out" id="sidebar">
        <div class="flex items-center justify-center h-16 bg-gray-800">
            <h1 class="text-xl font-bold text-white">üçΩÔ∏è Dieta Bot Admin</h1>
        </div>
        
        <nav class="mt-8">
            <div class="px-4 space-y-2">
                <a href="#" class="sidebar-active flex items-center px-4 py-2 text-sm font-medium rounded-lg" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    Dashboard
                </a>
                <a href="#" class="flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100" onclick="showSection('users')">
                    <i class="fas fa-users mr-3"></i>
                    Usu√°rios
                </a>
                <a href="#" class="flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100" onclick="showSection('subscriptions')">
                    <i class="fas fa-credit-card mr-3"></i>
                    Assinaturas
                </a>
                <a href="#" class="flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100" onclick="showSection('analytics')">
                    <i class="fas fa-chart-bar mr-3"></i>
                    Analytics
                </a>
                <a href="#" class="flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100" onclick="showSection('referrals')">
                    <i class="fas fa-share-alt mr-3"></i>
                    Refer√™ncias
                </a>
                <a href="#" class="flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100" onclick="showSection('payments')">
                    <i class="fas fa-money-bill-wave mr-3"></i>
                    Pagamentos
                </a>
                <a href="#" class="flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100" onclick="showSection('settings')">
                    <i class="fas fa-cog mr-3"></i>
                    Configura√ß√µes
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="ml-64">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="flex items-center justify-between px-6 py-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900" id="page-title">Dashboard</h2>
                    <p class="text-gray-600" id="page-subtitle">Vis√£o geral do sistema</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        √öltima atualiza√ß√£o: <span id="last-update">--</span>
                    </div>
                    <button onclick="refreshData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Atualizar
                    </button>
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section">
            <div class="p-6">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total de Usu√°rios</p>
                                <p class="text-2xl font-bold text-gray-900" id="total-users">--</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-credit-card text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Assinaturas Ativas</p>
                                <p class="text-2xl font-bold text-gray-900" id="active-subscriptions">--</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i class="fas fa-money-bill-wave text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Receita Mensal</p>
                                <p class="text-2xl font-bold text-gray-900" id="monthly-revenue">--</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-chart-line text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">An√°lises Hoje</p>
                                <p class="text-2xl font-bold text-gray-900" id="today-analyses">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Usu√°rios por Plano</h3>
                        <canvas id="plans-chart" width="400" height="200"></canvas>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Receita por M√™s</h3>
                        <canvas id="revenue-chart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Atividade Recente</h3>
                    </div>
                    <div class="p-6">
                        <div id="recent-activity" class="space-y-4">
                            <!-- Activity items will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users-section" class="section hidden">
            <div class="p-6">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Usu√°rios</h3>
                            <div class="flex items-center space-x-4">
                                <input type="text" placeholder="Buscar usu√°rio..." class="border border-gray-300 rounded-lg px-3 py-2 text-sm" id="user-search">
                                <button onclick="exportUsers()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                    <i class="fas fa-download mr-2"></i>
                                    Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usu√°rio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plano</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√öltima Atividade</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="users-table" class="bg-white divide-y divide-gray-200">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscriptions Section -->
        <div id="subscriptions-section" class="section hidden">
            <div class="p-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Planos por Status</h3>
                        <canvas id="subscription-status-chart" width="400" height="200"></canvas>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Convers√£o de Planos</h3>
                        <div id="conversion-stats">
                            <!-- Conversion stats will be loaded here -->
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Churn Rate</h3>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-red-600" id="churn-rate">--</div>
                            <p class="text-sm text-gray-600">√öltimos 30 dias</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Assinaturas</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usu√°rio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plano</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pr√≥ximo Pagamento</th>
                                </tr>
                            </thead>
                            <tbody id="subscriptions-table" class="bg-white divide-y divide-gray-200">
                                <!-- Subscriptions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics-section" class="section hidden">
            <div class="p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">An√°lises por Dia</h3>
                        <canvas id="analyses-chart" width="400" height="200"></canvas>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Alimentos Mais Analisados</h3>
                        <div id="top-foods">
                            <!-- Top foods will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">M√©tricas de Engajamento</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="avg-session-time">--</div>
                            <p class="text-sm text-gray-600">Tempo M√©dio de Sess√£o</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="retention-rate">--</div>
                            <p class="text-sm text-gray-600">Taxa de Reten√ß√£o</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="voice-usage">--</div>
                            <p class="text-sm text-gray-600">Uso de Comandos de Voz</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-600" id="photo-usage">--</div>
                            <p class="text-sm text-gray-600">An√°lises de Fotos</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Referrals Section -->
        <div id="referrals-section" class="section hidden">
            <div class="p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Referrers</h3>
                        <div id="top-referrers">
                            <!-- Top referrers will be loaded here -->
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Estat√≠sticas de Refer√™ncia</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total de Refer√™ncias</span>
                                <span class="font-semibold" id="total-referrals">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Taxa de Convers√£o</span>
                                <span class="font-semibold" id="referral-conversion">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Recompensas Pagas</span>
                                <span class="font-semibold" id="total-rewards">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Hist√≥rico de Refer√™ncias</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quem Indicou</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quem Foi Indicado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recompensa</th>
                                </tr>
                            </thead>
                            <tbody id="referrals-table" class="bg-white divide-y divide-gray-200">
                                <!-- Referrals will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payments Section -->
        <div id="payments-section" class="section hidden">
            <div class="p-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Receita por M√©todo</h3>
                        <canvas id="payment-methods-chart" width="400" height="200"></canvas>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Pagamentos por Status</h3>
                        <div id="payment-status">
                            <!-- Payment status will be loaded here -->
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Receita Total</h3>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-600" id="total-revenue">--</div>
                            <p class="text-sm text-gray-600">Este m√™s</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Transa√ß√µes</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usu√°rio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">M√©todo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                </tr>
                            </thead>
                            <tbody id="payments-table" class="bg-white divide-y divide-gray-200">
                                <!-- Payments will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" class="section hidden">
            <div class="p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Configura√ß√µes do Sistema</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Limite de An√°lises Gratuitas</label>
                                <input type="number" value="3" class="border border-gray-300 rounded-lg px-3 py-2 w-full" id="free-limit">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pre√ßo Premium (R$)</label>
                                <input type="number" value="29.90" step="0.01" class="border border-gray-300 rounded-lg px-3 py-2 w-full" id="premium-price">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pre√ßo Pro (R$)</label>
                                <input type="number" value="59.90" step="0.01" class="border border-gray-300 rounded-lg px-3 py-2 w-full" id="pro-price">
                            </div>
                            <button onclick="saveSettings()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                Salvar Configura√ß√µes
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">A√ß√µes do Sistema</h3>
                        <div class="space-y-4">
                            <button onclick="sendNotification()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                <i class="fas fa-bell mr-2"></i>
                                Enviar Notifica√ß√£o Global
                            </button>
                            <button onclick="backupData()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                <i class="fas fa-download mr-2"></i>
                                Backup dos Dados
                            </button>
                            <button onclick="clearCache()" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                <i class="fas fa-trash mr-2"></i>
                                Limpar Cache
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        let charts = {};
        let authToken = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });

        // Authentication functions
        function checkAuthentication() {
            authToken = localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');
            
            if (!authToken) {
                window.location.href = '/admin/login.html';
                return;
            }

            // Verify token
            fetch('/api/admin/verify', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Token inv√°lido');
                }
                return response.json();
            })
            .then(data => {
                // Update UI with user info
                updateUserInfo(data.user);
                loadDashboardData();
                setInterval(updateLastUpdate, 60000); // Update every minute
            })
            .catch(error => {
                console.error('Authentication failed:', error);
                logout();
            });
        }

        function updateUserInfo(user) {
            // Add user info to header
            const header = document.querySelector('header .flex.items-center.space-x-4');
            const userInfo = document.createElement('div');
            userInfo.className = 'flex items-center space-x-2';
            userInfo.innerHTML = `
                <span class="text-sm text-gray-600">Logado como: <strong>${user.username}</strong></span>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-sign-out-alt mr-1"></i>Sair
                </button>
            `;
            header.appendChild(userInfo);
        }

        function logout() {
            fetch('/api/admin/logout', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .finally(() => {
                localStorage.removeItem('adminToken');
                sessionStorage.removeItem('adminToken');
                window.location.href = '/admin/login.html';
            });
        }

        // Add authentication header to all requests
        function getAuthHeaders() {
            return {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            };
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            // Remove active class from all nav items
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('sidebar-active');
                link.classList.add('text-gray-700');
            });

            // Show selected section
            document.getElementById(sectionName + '-section').classList.remove('hidden');

            // Add active class to selected nav item
            event.target.classList.add('sidebar-active');
            event.target.classList.remove('text-gray-700');

            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'users': 'Usu√°rios',
                'subscriptions': 'Assinaturas',
                'analytics': 'Analytics',
                'referrals': 'Refer√™ncias',
                'payments': 'Pagamentos',
                'settings': 'Configura√ß√µes'
            };

            document.getElementById('page-title').textContent = titles[sectionName];
            document.getElementById('page-subtitle').textContent = getSubtitle(sectionName);

            // Load section data
            loadSectionData(sectionName);
        }

        function getSubtitle(sectionName) {
            const subtitles = {
                'dashboard': 'Vis√£o geral do sistema',
                'users': 'Gerenciar usu√°rios',
                'subscriptions': 'Monitorar assinaturas',
                'analytics': 'An√°lise de dados',
                'referrals': 'Sistema de refer√™ncia',
                'payments': 'Transa√ß√µes financeiras',
                'settings': 'Configura√ß√µes do sistema'
            };
            return subtitles[sectionName];
        }

        // Data loading functions
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                // Update stats
                document.getElementById('total-users').textContent = data.stats.total_users || 0;
                document.getElementById('active-subscriptions').textContent = data.stats.active_subscriptions || 0;
                document.getElementById('monthly-revenue').textContent = formatCurrency(data.stats.monthly_revenue || 0);
                document.getElementById('today-analyses').textContent = data.stats.today_analyses || 0;

                // Update charts
                updatePlansChart(data.plansStats);
                updateRevenueChart(data.revenueData);

                // Update recent activity
                updateRecentActivity(data.recentActivity);

            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
            }
        }

        async function loadSectionData(sectionName) {
            switch(sectionName) {
                case 'users':
                    await loadUsersData();
                    break;
                case 'subscriptions':
                    await loadSubscriptionsData();
                    break;
                case 'analytics':
                    await loadAnalyticsData();
                    break;
                case 'referrals':
                    await loadReferralsData();
                    break;
                case 'payments':
                    await loadPaymentsData();
                    break;
            }
        }

        async function loadUsersData() {
            try {
                const response = await fetch('/api/users', {
                    headers: getAuthHeaders()
                });
                const users = await response.json();
                updateUsersTable(users);
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
            }
        }

        async function loadSubscriptionsData() {
            try {
                const response = await fetch('/api/subscriptions');
                const data = await response.json();
                updateSubscriptionsTable(data.subscriptions);
                updateSubscriptionCharts(data.stats);
            } catch (error) {
                console.error('Erro ao carregar assinaturas:', error);
            }
        }

        async function loadAnalyticsData() {
            try {
                const response = await fetch('/api/analytics');
                const data = await response.json();
                updateAnalyticsCharts(data);
            } catch (error) {
                console.error('Erro ao carregar analytics:', error);
            }
        }

        async function loadReferralsData() {
            try {
                const response = await fetch('/api/referrals');
                const data = await response.json();
                updateReferralsTable(data.referrals);
                updateReferralsStats(data.stats);
            } catch (error) {
                console.error('Erro ao carregar refer√™ncias:', error);
            }
        }

        async function loadPaymentsData() {
            try {
                const response = await fetch('/api/payments');
                const data = await response.json();
                updatePaymentsTable(data.payments);
                updatePaymentCharts(data.stats);
            } catch (error) {
                console.error('Erro ao carregar pagamentos:', error);
            }
        }

        // Chart functions
        function updatePlansChart(data) {
            const ctx = document.getElementById('plans-chart').getContext('2d');
            
            if (charts.plans) {
                charts.plans.destroy();
            }

            charts.plans = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Gratuito', 'Premium', 'Pro', 'VIP'],
                    datasets: [{
                        data: [data.free || 0, data.premium || 0, data.pro || 0, data.vip || 0],
                        backgroundColor: ['#6B7280', '#3B82F6', '#8B5CF6', '#F59E0B']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateRevenueChart(data) {
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            
            if (charts.revenue) {
                charts.revenue.destroy();
            }

            charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels || [],
                    datasets: [{
                        label: 'Receita (R$)',
                        data: data.values || [],
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Table update functions
        function updateUsersTable(users) {
            const tbody = document.getElementById('users-table');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                    <span class="text-sm font-medium text-gray-700">${user.phone.slice(-2)}</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.name || 'Usu√°rio'}</div>
                                <div class="text-sm text-gray-500">${user.phone}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getPlanBadgeClass(user.planType)}">
                            ${getPlanName(user.planType)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatDate(user.last_meal)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            Ativo
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewUser('${user.phone}')" class="text-blue-600 hover:text-blue-900 mr-3">Ver</button>
                        <button onclick="editUser('${user.phone}')" class="text-indigo-600 hover:text-indigo-900">Editar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateSubscriptionsTable(subscriptions) {
            const tbody = document.getElementById('subscriptions-table');
            tbody.innerHTML = '';

            subscriptions.forEach(sub => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sub.userPhone}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getPlanBadgeClass(sub.planType)}">
                            ${getPlanName(sub.planType)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(sub.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(sub.status)}">
                            ${getStatusName(sub.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(sub.nextPayment)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateReferralsTable(referrals) {
            const tbody = document.getElementById('referrals-table');
            tbody.innerHTML = '';

            referrals.forEach(ref => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ref.referrerPhone}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ref.refereePhone}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(ref.createdAt)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(ref.status)}">
                            ${getStatusName(ref.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(ref.reward)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePaymentsTable(payments) {
            const tbody = document.getElementById('payments-table');
            tbody.innerHTML = '';

            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${payment.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${payment.userPhone}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(payment.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${payment.method}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(payment.status)}">
                            ${getStatusName(payment.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(payment.createdAt)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '--';
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        function getPlanName(planType) {
            const plans = {
                'free': 'Gratuito',
                'premium': 'Premium',
                'pro': 'Pro',
                'vip': 'VIP'
            };
            return plans[planType] || 'Desconhecido';
        }

        function getPlanBadgeClass(planType) {
            const classes = {
                'free': 'bg-gray-100 text-gray-800',
                'premium': 'bg-blue-100 text-blue-800',
                'pro': 'bg-purple-100 text-purple-800',
                'vip': 'bg-yellow-100 text-yellow-800'
            };
            return classes[planType] || 'bg-gray-100 text-gray-800';
        }

        function getStatusName(status) {
            const statuses = {
                'active': 'Ativo',
                'inactive': 'Inativo',
                'pending': 'Pendente',
                'completed': 'Conclu√≠do',
                'failed': 'Falhou',
                'canceled': 'Cancelado'
            };
            return statuses[status] || status;
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'active': 'bg-green-100 text-green-800',
                'inactive': 'bg-gray-100 text-gray-800',
                'pending': 'bg-yellow-100 text-yellow-800',
                'completed': 'bg-green-100 text-green-800',
                'failed': 'bg-red-100 text-red-800',
                'canceled': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function updateLastUpdate() {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('pt-BR');
        }

        function refreshData() {
            const currentSection = document.querySelector('.section:not(.hidden)').id.replace('-section', '');
            loadSectionData(currentSection);
            updateLastUpdate();
        }

        // Action functions
        function viewUser(phone) {
            alert(`Visualizar usu√°rio: ${phone}`);
        }

        function editUser(phone) {
            alert(`Editar usu√°rio: ${phone}`);
        }

        function exportUsers() {
            alert('Exportando usu√°rios...');
        }

        function sendNotification() {
            const message = prompt('Digite a mensagem da notifica√ß√£o:');
            if (message) {
                alert(`Notifica√ß√£o enviada: ${message}`);
            }
        }

        function backupData() {
            alert('Iniciando backup dos dados...');
        }

        function clearCache() {
            if (confirm('Tem certeza que deseja limpar o cache?')) {
                alert('Cache limpo com sucesso!');
            }
        }

        function saveSettings() {
            alert('Configura√ß√µes salvas com sucesso!');
        }

        // Placeholder functions for chart updates
        function updateSubscriptionCharts(stats) {
            // Update subscription charts
        }

        function updateAnalyticsCharts(data) {
            // Update analytics charts
        }

        function updateReferralsStats(stats) {
            // Update referrals stats
        }

        function updatePaymentCharts(stats) {
            // Update payment charts
        }

        function updateRecentActivity(activities) {
            const container = document.getElementById('recent-activity');
            container.innerHTML = '';

            activities.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-3';
                div.innerHTML = `
                    <div class="flex-shrink-0">
                        <div class="h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center">
                            <i class="fas fa-user text-xs text-gray-600"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-900">${activity.description}</p>
                        <p class="text-xs text-gray-500">${formatDate(activity.timestamp)}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>
